<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-R8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Node.js Downloader</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 2em; background: #f4f7f6; }
        h1 { color: #333; }
        #downloadForm { margin-bottom: 20px; }
        #urlInput { width: 400px; padding: 8px; font-size: 1em; }
        button { padding: 9px 15px; font-size: 1em; cursor: pointer; border: none; border-radius: 3px; }
        #downloadForm button { background: #007bff; color: white; }
        
        #totalSpeed { font-size: 1.2em; font-weight: bold; color: #0056b3; margin-bottom: 10px; }
        
        #globalControls { margin-bottom: 20px; }
        #globalControls button {
            margin-right: 10px;
            color: white;
        }
        #globalControls .resume-all-btn { background: #28a745; }
        #globalControls .pause-all-btn { background: #ffc107; }

        #downloadsList { list-style: none; padding: 0; }
        .download-item { background: #fff; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; border-radius: 5px; }
        .progress-bar-container { background: #eee; border-radius: 5px; overflow: hidden; height: 20px; margin-top: 10px; }
        .progress-bar { background: #007bff; height: 100%; width: 0%; transition: width 0.2s linear; }
        .status-text { margin-top: 5px; font-size: 0.9em; color: #555; }
        .status-complete { color: green; }
        .status-error { color: red; }
        .status-paused { color: #6c757d; }
        .status-queued { color: #17a2b8; }
        
        .download-controls { margin-top: 10px; }
        .download-controls .pause-btn { background: #ffc107; }
        .download-controls .resume-btn { background: #28a745; }
        .download-controls .resume-btn, .download-controls .pause-btn {
            border: none; color: white; border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Node.js Downloader</h1>
    
    <form id="downloadForm">
        <input type="text" id="urlInput" placeholder="Enter file URL (must support Range requests)" required>
        <button type="submit">Download</button>
    </form>

    <div id="totalSpeed">Total Speed: 0 B/s</div>

    <div id="globalControls">
        <button id="resumeAllBtn" class="resume-all-btn">Resume All</button>
        <button id="pauseAllBtn" class="pause-all-btn">Pause All</button>
    </div>
    <ul id="downloadsList"></ul>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const form = document.getElementById('downloadForm');
        const urlInput = document.getElementById('urlInput');
        const downloadsList = document.getElementById('downloadsList');
        const totalSpeedElement = document.getElementById('totalSpeed');
        const resumeAllBtn = document.getElementById('resumeAllBtn');
        const pauseAllBtn = document.getElementById('pauseAllBtn');

        // --- Helper Functions ---
        function formatBytes(bytes, decimals = 2) {
            if (!+bytes) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return `${parseFloat((bytes / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }
        function formatSpeed(bytesPerSecond, decimals = 2) {
            if (!+bytesPerSecond) return '0 B/s';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['B/s', 'KB/s', 'MB/s', 'GB/s', 'TB/s'];
            const i = Math.floor(Math.log(bytesPerSecond) / Math.log(k));
            return `${parseFloat((bytesPerSecond / Math.pow(k, i)).toFixed(dm))} ${sizes[i]}`;
        }

        // --- NEW: Format ETA (Estimated Time Remaining) ---
        function formatETA(seconds) {
            if (seconds === null || !isFinite(seconds) || seconds < 0) {
                return 'N/A';
            }
            if (seconds === 0) {
                return 'Done';
            }

            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = Math.floor(seconds % 60);

            let etaString = '';
            if (h > 0) etaString += `${h}h `;
            if (m > 0) etaString += `${m}m `;
            if (s >= 0) etaString += `${s}s`;
            
            return etaString.trim() + ' left';
        }
        // ----------------------------------------------------

        /**
         * Creates or updates a download item in the DOM
         */
        function renderDownloadItem(download) {
            let item = document.getElementById(`download-${download.id}`);
            if (!item) {
                item = document.createElement('li');
                item.id = `download-${download.id}`;
                item.classList.add('download-item');
                downloadsList.prepend(item); 
            }

            const progress = (download.downloadedSize / download.totalSize) * 100 || 0;
            let statusHtml;
            let controlsHtml = '';

            switch (download.status) {
                case 'downloading':
                    // --- UPDATED: Add ETA ---
                    const etaString = formatETA(download.eta);
                    statusHtml = `Downloading: ${progress.toFixed(2)}% (${formatBytes(download.downloadedSize)} / ${formatBytes(download.totalSize)}) - ${formatSpeed(download.currentSpeed)} - <strong>${etaString}</strong>`;
                    controlsHtml = `<button class="pause-btn" data-id="${download.id}">Pause</button>`;
                    break;
                case 'paused':
                    statusHtml = `<strong class="status-paused">Paused:</strong> ${progress.toFixed(2)}% (${formatBytes(download.downloadedSize)})`;
                    controlsHtml = `<button class="resume-btn" data-id="${download.id}">Resume</button>`;
                    break;
                case 'queued':
                    statusHtml = `<strong class="status-queued">Queued...</strong> (${progress.toFixed(2)}%)`;
                    controlsHtml = `<button class="pause-btn" data-id="${download.id}">Pause</button>`;
                    break;
                case 'complete':
                    statusHtml = `<strong class="status-complete">Download Complete!</strong> (${formatBytes(download.totalSize)})`;
                    break;
                case 'error':
                    statusHtml = `<strong class="status-error">Error:</strong> ${download.error}`;
                    controlsHtml = `<button class="resume-btn" data-id="${download.id}">Retry</button>`;
                    break;
                case 'assembling':
                    statusHtml = `<strong>Assembling file...</strong>`;
                    break;
                default:
                    statusHtml = `Starting...`;
            }

            item.innerHTML = `
                <strong>${download.filename}</strong>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: ${progress.toFixed(2)}%;"></div>
                </div>
                <div class="status-text">${statusHtml}</div>
                <div class="download-controls">${controlsHtml}</div>
            `;
            
            const bar = item.querySelector('.progress-bar');
            if (download.status === 'complete') bar.style.backgroundColor = '#28a745';
            else if (download.status === 'error') bar.style.backgroundColor = '#dc3545';
            else if (download.status === 'paused') bar.style.backgroundColor = '#6c757d';
            else if (download.status === 'queued') bar.style.backgroundColor = '#17a2b8';
            else if (download.status === 'downloading') bar.style.backgroundColor = '#007bff';
        }

        // --- Form & Button Event Listeners ---
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const url = urlInput.value.trim();
            if (url) {
                socket.emit('start-download', { url });
                urlInput.value = '';
            }
        });

        downloadsList.addEventListener('click', (e) => {
            const id = e.target.dataset.id;
            if (!id) return;
            if (e.target.classList.contains('pause-btn')) {
                socket.emit('pause-download', { id });
            }
            if (e.target.classList.contains('resume-btn')) {
                socket.emit('resume-download', { id });
            }
        });

        resumeAllBtn.addEventListener('click', () => {
            socket.emit('resume-all-downloads');
        });

        pauseAllBtn.addEventListener('click', () => {
            socket.emit('pause-all-downloads');
        });

        // --- Socket.io Event Handlers ---

        socket.on('download-list', (downloads) => {
            downloadsList.innerHTML = ''; 
            downloads.sort((a, b) => b.id - a.id); 
            downloads.forEach(renderDownloadItem);
        });
        
        socket.on('download-started', (download) => {
            renderDownloadItem(download);
        });

        // A download is making progress
        socket.on('download-progress', ({ id, progress, downloaded, totalSize, speed, eta }) => { // <-- ETA is here
            const item = document.getElementById(`download-${id}`);
            if (item) {
                const bar = item.querySelector('.progress-bar');
                const status = item.querySelector('.status-text');
                bar.style.width = `${progress.toFixed(2)}%`;
                bar.style.backgroundColor = '#007bff';
                
                // --- UPDATED: Add ETA ---
                const etaString = formatETA(eta);
                status.innerHTML = `Downloading: ${progress.toFixed(2)}% (${formatBytes(downloaded)} / ${formatBytes(totalSize)}) - ${formatSpeed(speed)} - <strong>${etaString}</strong>`;
                // ------------------------
                
                const controls = item.querySelector('.download-controls');
                if (!controls.querySelector('.pause-btn')) {
                    controls.innerHTML = `<button class="pause-btn" data-id="${id}">Pause</button>`;
                }
            }
        });

        // Download is complete
        socket.on('download-complete', ({ id }) => {
            const item = document.getElementById(`download-${id}`);
            if (item) {
                const bar = item.querySelector('.progress-bar');
                const status = item.querySelector('.status-text');
                bar.style.width = '100%';
                bar.style.backgroundColor = '#28a745';
                status.innerHTML = `<strong class="status-complete">Download Complete!</strong>`;
                item.querySelector('.download-controls').innerHTML = ''; 
            }
        });

        // An error occurred
        socket.on('download-error', ({ id, error }) => {
            let item = document.getElementById(`download-${id}`);
            if (item) {
                const bar = item.querySelector('.progress-bar');
                const status = item.querySelector('.status-text');
                status.innerHTML = `<strong class="status-error">Error:</strong> ${error}`;
                bar.style.backgroundColor = '#dc3545';
                item.querySelector('.download-controls').innerHTML = 
                    `<button class="resume-btn" data-id="${id}">Retry</button>`;
            } else {
                alert(`Error starting download for ${id}: ${error}`);
            }
        });

        // Update total speed
        socket.on('total-speed-update', ({ totalSpeed }) => {
            totalSpeedElement.textContent = `Total Speed: ${formatSpeed(totalSpeed)}`;
        });
    </script>
</body>
</html>